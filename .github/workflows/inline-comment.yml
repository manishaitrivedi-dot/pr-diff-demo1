name: Inline Review

on:
  pull_request:
    types: [opened, reopened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install deps
        run: pip install requests

      # ðŸ”´ Make sure TARGET_FILE matches your real path: if the file is in repo root, use just "simple_test.py"
      - name: Prepare LLM chunks (build position map)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          TARGET_FILE: simple_test.py
          ONLY_DIFF: "true"
          MAX_CHARS: "800"     # small window for demo
          CTX_LINES: "3"
        run: python prepare_llm_chunks.py

      - name: Debug: show artifacts
        run: |
          echo "--- llm_chunks.json ---"
          cat llm_chunks.json || true
          echo "--- line_to_position.json ---"
          cat line_to_position.json || true
          echo "--- llm_chunks.md (first 120 lines) ---"
          head -n 120 llm_chunks.md || true

      - name: Post inline comments
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          TARGET_FILE: simple_test.py
        run: python inline_comment.py
