name: LLM Any-Line Annotations

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  annotate:
    # Only run on PR events (prevents accidental push-to-main runs)
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # keep full diff context

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests

      # Build chunks + (optionally) line->position map
      # ONLY_DIFF=false means: chunk the *entire* file (not just diff).
      - name: Prepare LLM chunks
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          TARGET_FILE: scripts/simple_test.py
          ONLY_DIFF: "false"
          MAX_CHARS: "200"     # tiny on purpose so you can see multiple chunks
          CTX_LINES: "2"
        run: python prepare_llm_chunks.py

      # Post comments. Your script should:
      # - use line_to_position.json if it exists (inline on diff lines)
      # - otherwise fall back to a PR review summary (file-level) for any-line notes
      - name: Post inline comments
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: python inline_comment.py
