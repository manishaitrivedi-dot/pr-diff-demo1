name: Code Review

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - run: |
          pip install snowflake-connector-python tiktoken whatthepatch snowflake-snowpark-python snowflake-ml-python pandas requests
      
      - run: |
          mkdir -p chunks
          echo "Copying files with content verification:"
          if [ -f "scripts/simple_test.py" ]; then
            cp scripts/simple_test.py chunks/
            echo "simple_test.py size: $(wc -c < chunks/simple_test.py) bytes"
            echo "First 200 chars of simple_test.py:"
            head -c 200 chunks/simple_test.py
          else
            echo "simple_test.py not found in scripts/"
          fi
          
          find scripts/ -name "*.py" -type f | head -5 | while read file; do
            cp "$file" chunks/
            echo "Copied: $file ($(wc -c < "$file") bytes)"
          done
      
      - run: |
          mkdir -p reviews
          echo "Files being processed:"
          ls -la chunks/
          echo "Running cortex review..."
          python scripts/cortex_python_review.py chunks reviews 123 abc123
        env:
          SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
          SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
          SNOWFLAKE_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE }}
          SNOWFLAKE_SCHEMA: ${{ secrets.SNOWFLAKE_SCHEMA }}
          SNOWFLAKE_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
        continue-on-error: true
      
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: outputs
          path: reviews/
      
      - run: |
          echo "Fixing review_output.json structure..."
          if [ -f "review_output.json" ]; then
            python3 -c "
import json
try:
    with open('review_output.json', 'r') as f:
        data = json.load(f)
    
    # Add missing 'line' field to critical findings
    if 'criticals' in data and isinstance(data['criticals'], list):
        for critical in data['criticals']:
            if isinstance(critical, dict):
                if 'line' not in critical:
                    critical['line'] = 1
                if 'line_number' in critical and 'line' not in critical:
                    critical['line'] = critical['line_number']
                    
    with open('review_output.json', 'w') as f:
        json.dump(data, f, indent=2)
    print('Fixed JSON structure')
except Exception as e:
    print(f'JSON fix failed: {e}')
"
          else
            echo "review_output.json not found"
          fi
        continue-on-error: true

      - run: python scripts/inline_comment.py || echo "Inline completed"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
