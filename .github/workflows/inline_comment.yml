name: Inline Comment Bot
on:
  pull_request:
    branches:
      - main                # run when PRs target main
    types: [opened, synchronize, reopened]
  push:
    branches:
      - fix/**
      - main
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"
          
      - name: Install dependencies
        run: pip install requests snowflake-snowpark-python
        
      - name: Find PR number for push events
        id: find-pr
        if: github.event_name == 'push'
        run: |
          # Find PR number associated with this branch
          PR_NUMBER=$(gh pr list --head "${{ github.ref_name }}" --json number --jq '.[0].number // empty')
          if [ -n "$PR_NUMBER" ]; then
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            echo "Found PR #$PR_NUMBER for branch ${{ github.ref_name }}"
          else
            echo "No PR found for branch ${{ github.ref_name }}"
            echo "pr_number=" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Run inline comment script
        if: |
          (github.event_name == 'pull_request') || 
          (github.event_name == 'push' && steps.find-pr.outputs.pr_number != '')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event_name == 'pull_request' && github.event.pull_request.number || steps.find-pr.outputs.pr_number }}
          # Snowflake credentials
          SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
          SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
          SNOWFLAKE_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE }}
          SNOWFLAKE_SCHEMA: ${{ secrets.SNOWFLAKE_SCHEMA }}
          SNOWFLAKE_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
        run: python scripts/inline_comment.py
