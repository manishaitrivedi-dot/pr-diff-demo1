name: Automated Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  code-review:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        pip install requests
        
    - name: Post Code Review Comments
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        PR_NUMBER: ${{ github.event.number }}
      run: |
        python -c "
        import os
        import requests
        import json

        token = os.environ['GITHUB_TOKEN']
        pr_number = os.environ['PR_NUMBER']
        repo = '${{ github.repository }}'

        headers = {
            'Authorization': f'token {token}',
            'Accept': 'application/vnd.github.v3+json'
        }

        # Sample comments
        comments = [
            {'path': 'simple_test.py', 'line': 1, 'body': 'Consider adding a docstring'},
            {'path': 'simple_test.py', 'line': 5, 'body': 'Consider using constants for strings'}
        ]

        # Get PR info
        pr_url = f'https://api.github.com/repos/{repo}/pulls/{pr_number}'
        pr_resp = requests.get(pr_url, headers=headers)
        commit_sha = pr_resp.json()['head']['sha']

        # Post comments
        for comment in comments:
            payload = {
                'body': comment['body'],
                'commit_id': commit_sha,
                'path': comment['path'],
                'line': comment['line']
            }
            
            comment_url = f'https://api.github.com/repos/{repo}/pulls/{pr_number}/comments'
            resp = requests.post(comment_url, headers=headers, json=payload)
            print(f'Posted comment: {resp.status_code}')
        "
