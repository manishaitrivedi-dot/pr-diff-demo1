import os
import requests
import json

def post_inline_comments():
    """Post sample inline comments to GitHub PR"""
    
    # Configuration - UPDATE THESE VALUES
    GITHUB_TOKEN = os.getenv('GITHUB_TOKEN')  # Set this environment variable
    REPO_OWNER = 'manishaitrivedi-dot'        # Your GitHub username
    REPO_NAME = 'pr-diff-demo1'               # Your repository name
    PR_NUMBER = 1                             # Pull request number
    
    # Check if token is set
    if not GITHUB_TOKEN:
        print("Error: Set GITHUB_TOKEN environment variable")
        print("Example: export GITHUB_TOKEN=your_token_here")
        return
    
    # Sample comments to post (CUSTOMIZE THESE)
    sample_comments = [
        {
            'file_path': 'demo.py',
            'line_number': 1,
            'comment': 'Consider adding a docstring to explain what this function does.'
        },
        {
            'file_path': 'hello.py',
            'line_number': 1,
            'comment': 'This is a clean implementation. You might want to add error handling.'
        },
        {
            'file_path': 'sample.py',
            'line_number': 1,
            'comment': 'Consider using f-strings for better performance and readability.'
        },
        {
            'file_path': 'new_test.py',
            'line_number': 2,
            'comment': 'Good variable naming. Consider adding type hints for better code documentation.'
        }
    ]
    
    # GitHub API setup
    headers = {
        'Authorization': f'token {GITHUB_TOKEN}',
        'Accept': 'application/vnd.github.v3+json',
        'Content-Type': 'application/json'
    }
    
    base_url = f'https://api.github.com/repos/{REPO_OWNER}/{REPO_NAME}'
    
    try:
        # Get PR info to get the commit SHA
        print(f"Getting PR #{PR_NUMBER} info...")
        pr_response = requests.get(f'{base_url}/pulls/{PR_NUMBER}', headers=headers)
        pr_response.raise_for_status()
        pr_data = pr_response.json()
        commit_sha = pr_data['head']['sha']
        
        print(f"PR Title: {pr_data['title']}")
        print(f"Commit SHA: {commit_sha}")
        print(f"Posting {len(sample_comments)} inline comments...")
        
        # Post each comment
        success_count = 0
        for i, comment_data in enumerate(sample_comments, 1):
            print(f"\n[{i}/{len(sample_comments)}] Posting comment on {comment_data['file_path']}:{comment_data['line_number']}")
            
            # Prepare comment data
            payload = {
                'body': comment_data['comment'],
                'commit_id': commit_sha,
                'path': comment_data['file_path'],
                'line': comment_data['line_number']
            }
            
            # Post the comment
            comment_response = requests.post(
                f'{base_url}/pulls/{PR_NUMBER}/comments',
                headers=headers,
                json=payload
            )
            
            if comment_response.status_code == 201:
                print(f" Comment posted successfully!")
                success_count += 1
            else:
                print(f"Failed to post comment: {comment_response.status_code}")
                print(f"Response: {comment_response.text}")
        
        print(f"\n Summary: {success_count}/{len(sample_comments)} comments posted successfully!")
        
        # Post a general review summary
        review_payload = {
            'body': f"""## Automated Code Review Summary

Posted {success_count} inline comments on specific lines of code.

### Key Areas Reviewed:
- Code documentation and docstrings
- Error handling patterns
- Performance optimizations
- Code readability improvements

Review generated by automated system.""",
            'event': 'COMMENT'
        }
        
        review_response = requests.post(
            f'{base_url}/pulls/{PR_NUMBER}/reviews',
            headers=headers,
            json=review_payload
        )
        
        if review_response.status_code == 200:
            print(" General review summary posted!")
        
    except requests.exceptions.RequestException as e:
        print(f" API Error: {str(e)}")
    except Exception as e:
        print(f" Error: {str(e)}")

def customize_comments():
    """
    Function to help you customize comments for your specific files
    Update this function with your own file names and comments
    """
    custom_comments = [
        {
            'file_path': 'your_file.py',  # Change to your actual file name
            'line_number': 1,             # Line number to comment on
            'comment': 'Your custom review comment here'
        },
        # Add more comments as needed
    ]
    return custom_comments

if __name__ == "__main__":
    print(" Starting GitHub inline comment posting...")
    print("\nMake sure you have:")
    print("1. Set GITHUB_TOKEN environment variable")
    print("2. Updated REPO_OWNER, REPO_NAME, and PR_NUMBER in the script")
    print("3. Customized the sample_comments list\n")
    
    post_inline_comments()
